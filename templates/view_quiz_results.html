{% extends "base.html" %}
{% block content %}



<!-- <button class="btn btn-outline-light mode-toggle" onclick="toggleMode()">üåì Toggle Mode</button> -->

<h2 class="mb-4 heading-dynamic"> Results for Quiz: {{ quiz.title }}</h2>

{% if results %}
<form method="POST" action="{{ url_for('release_quiz_report', quiz_id=quiz.id) }}" onsubmit="return confirm('Release reports to all students?')">
  <button type="submit" class="btn btn-primary mb-3">üì§ Release Reports to All</button>
</form>

<div class="d-flex justify-content-between align-items-center mb-3 flex-wrap gap-2">
  <button class="btn btn-success" onclick="exportToCSV()">üìÅ Export CSV</button>
  <select id="gradeFilter" class="form-select w-auto" onchange="filterByGrade()">
    <option value="">Filter by Grade</option>
    <option value="A">Grade A (90-100%)</option>
    <option value="B">Grade B (75-89%)</option>
    <option value="C">Grade C (60-74%)</option>
    <option value="D">Grade D (40-59%)</option>
    <option value="F">Grade F (0-39%)</option>
  </select>
</div>

<div class="text-end mb-2">
  <form method="POST" action="{{ url_for('reset_all_students', quiz_id=quiz.id) }}" onsubmit="return confirm('Are you sure you want to reset all student attempts? This action cannot be undone.')">
    <button type="submit" class="btn btn-outline-danger btn-sm" data-bs-toggle="tooltip" title="Reset all student submissions. Use carefully!">
      ‚ùå Reset All
    </button>
  </form>
</div>

<table id="resultsTable" class="table table-striped table-hover table-bordered shadow-sm">
  <thead>
    <tr>
      <th>Student</th>
      <th>Score</th>
      <th>Total</th>
      <th>Percentage</th>
      <th>Submitted At</th>
      <th>Actions</th>
    </tr>
  </thead>
  <tbody>
    {% for data in chart_data %}
    <tr data-grade="{{ data.grade }}">
      <td>{{ data.username }}</td>
      <td>{{ data.score }}</td>
      <td>{{ data.total_questions * quiz.marks_correct }}</td>
      <td>{{ "%.1f"|format(data.percentage) }}%</td>
      <td>{{ data.submitted_at or "‚Äî" }}</td>

      <td class="d-flex gap-1">
<a href="{{ url_for('professor_view_student_report', quiz_id=quiz.id, student_id=data['student_id']) }}" class="btn btn-sm btn-info">
    View Report
</a>

      <form method="POST" action="{{ url_for('reset_student_quiz', quiz_id=quiz.id, student_username=data.username) }}" onsubmit="return confirm('Reset quiz attempt for {{ data.username }}?')">
        <button type="submit" class="btn btn-sm btn-danger">Reset</button>
      </form>
    </td>

    </tr>
    {% endfor %}
  </tbody>
</table>
<br>

<div class="d-flex justify-content-between align-items-center mb-2">
  <h4 class="heading-dynamic">üèÜ Student Leaderboard</h4>
  <select id="topNFilter" class="form-select w-auto" onchange="updateLeaderboard()">
    <option value="3" selected>Top 3</option>
    <option value="5">Top 5</option>
    <option value="10">Top 10</option>
    <option value="all">Show All</option>
  </select>
</div>

<table class="table table-hover table-bordered shadow-sm mt-3">
  <thead>
    <tr>
      <th>Rank</th>
      <th>Student</th>
      <th>Score</th>
      <th>Total</th>
      <th>Percentage</th>
    </tr>
  </thead>
  <tbody id="leaderboardBody">
    {% for data in chart_data|sort(attribute='percentage', reverse=True) %}
    <tr data-index="{{ loop.index }}">
      <td>{{ loop.index }}</td>
      <td>{{ data.username }}</td>
      <td>{{ data.score }}</td>
      <td>{{ data.total_questions * quiz.marks_correct }}</td>
      <td>{{ "%.1f"|format(data.percentage) }}%</td>
    </tr>
    {% endfor %}
  </tbody>
</table>

<hr class="my-5">
<h4 class="mb-3 heading-dynamic">Question Analytics</h4>
<table class="table table-bordered table-sm table-striped">

  <thead>
    <tr>
      <th>#</th>
      <th>Question</th>
      <th>‚úÖ Correct</th>
      <th>‚ùå Incorrect</th>
      <th>‚è≥ Unanswered</th>
    </tr>
  </thead>
  <tbody>
    {% for q in question_stats %}
    <tr>
      <td>{{ loop.index }}</td>
      <td title="{{ q.text }}">{{ q.text[:80] }}{% if q.text|length > 80 %}...{% endif %}</td>
      <td class="text-success">{{ q.correct }}</td>
      <td class="text-danger">{{ q.incorrect }}</td>
      <td class="unanswered-cell">{{ q.unanswered }}</td>

    </tr>
    {% endfor %}
  </tbody>
</table>

{% for data in chart_data %}
<div class="modal fade" id="modal_{{ loop.index }}" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title"> {{ data.username }} - Quiz Breakdown</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <canvas id="chart_{{ loop.index }}"></canvas>
      </div>
    </div>
  </div>
</div>
{% endfor %}

<hr class="my-5">
<div class="mt-4">
  <canvas id="questionPerformanceChart"></canvas>
</div>

<hr class="my-5">
<h4 class="mb-3 heading-dynamic">Grade Distribution</h4>
<canvas id="pieChart" style="max-width: 400px; margin: auto;"></canvas>

{% else %}
<p class="text-muted">No students have taken this quiz yet.</p>
{% endif %}

<a href="{{ url_for('professor_dashboard') }}" class="btn btn-secondary mt-4">‚¨ÖÔ∏è Back to Dashboard</a>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
function toggleMode() {
    const body = document.body;
    body.classList.toggle("dark-mode");
    body.classList.toggle("light-mode");
    localStorage.setItem("theme", body.classList.contains("dark-mode") ? "dark" : "light");
}
window.onload = function () {
    const saved = localStorage.getItem("theme");
    document.body.classList.add(saved === "dark" ? "dark-mode" : "light-mode");
}

const chartData = {{ chart_data | tojson }};
const percentages = chartData.map(d => d.percentage);

function updateLeaderboard() {
  const selectedValue = document.getElementById("topNFilter").value;
  const rows = document.querySelectorAll("#leaderboardBody tr");
  let limit = rows.length;
  if (selectedValue !== 'all') {
    limit = parseInt(selectedValue);
  }
  rows.forEach((row, index) => {
    row.style.display = (index < limit) ? "" : "none";
  });
}

document.addEventListener("DOMContentLoaded", function () {
  updateLeaderboard();
});

function filterByGrade() {
  const selected = document.getElementById("gradeFilter").value;
  document.querySelectorAll("#resultsTable tbody tr").forEach(row => {
    row.style.display = (selected === "" || row.dataset.grade === selected) ? "" : "none";
  });
}

function exportToCSV() {
  let csv = 'Student,Score,Total,Percentage,Submitted At\n';
  document.querySelectorAll("#resultsTable tbody tr").forEach(row => {
    if (row.style.display !== 'none') {
      let cells = row.querySelectorAll("td");
      let rowData = Array.from(cells).slice(0, 5).map(cell => cell.textContent.trim()).join(",");
      csv += rowData + '\n';
    }
  });
  const blob = new Blob([csv], { type: 'text/csv' });
  const link = document.createElement("a");
  link.href = URL.createObjectURL(blob);
  link.download = "{{ quiz.title | replace(' ', '_') }}_results.csv";
  link.click();
}
const isDarkMode = document.body.classList.contains('dark-mode');

// PIE CHART - Score Breakdown (per student)
chartData.forEach((student, index) => {
  const ctx = document.getElementById('chart_' + (index + 1)).getContext('2d');
  new Chart(ctx, {
    type: 'pie',
    data: {
      labels: ['Marks Scored', 'Remaining Marks'],
      datasets: [{
        data: [
          student.score,
          student.total_questions * {{ quiz.marks_correct }} - student.score
        ],
        backgroundColor: ['#36a2eb', '#ff6384']
      }]
    },
    options: {
      plugins: {
        title: {
          display: true,
          text: 'Score Breakdown (in marks)',
          color: '#fff'
        },
        legend: {
          labels: {
            color: '#fff'
          }
        },
        tooltip: {
          backgroundColor: isDarkMode ? '#333' : '#fff',
          titleColor: isDarkMode ? '#fff' : '#000',
          bodyColor: isDarkMode ? '#fff' : '#000'
        }
      }
    }
  });
});

// BAR CHART - Per Question Performance
const questionStats = {{ question_stats | tojson }};
const labels = questionStats.map((_, idx) => "Q" + (idx + 1));
const correct = questionStats.map(q => q.correct);
const incorrect = questionStats.map(q => q.incorrect);
const unanswered = questionStats.map(q => q.unanswered);


new Chart(document.getElementById('questionPerformanceChart'), {
  type: 'bar',
  data: {
    labels: labels,
    datasets: [
                {
                  label: 'Correct',
                  data: correct,
                  backgroundColor: '#2ecc71'
                },
                {
                  label: 'Incorrect',
                  data: incorrect,
                  backgroundColor: '#e74c3c'
                },
                {
                  label: 'Unanswered',
                  data: unanswered,
                  backgroundColor: '#f1c40f'
                }
              ]

  },
  options: {
    responsive: true,
    plugins: {
      title: {
        display: true,
        text: 'Per Question Performance',
        color: '#fff'
      },
      legend: {
        labels: {
          color: '#fff'
        }
      },
      tooltip: {
        backgroundColor: isDarkMode ? '#333' : '#fff',
        titleColor: isDarkMode ? '#fff' : '#000',
        bodyColor: isDarkMode ? '#fff' : '#000'
      }
    },
    scales: {
      y: {
        beginAtZero: true,
        ticks: {
          color: '#fff'
        }
      },
      x: {
        ticks: {
          color: '#fff'
        }
      }
    }
  }
});

// PIE CHART - Grade Distribution
const gradeBuckets = { A: 0, B: 0, C: 0, D: 0, F: 0 };
percentages.forEach(p => {
  if (p >= 90) gradeBuckets.A++;
  else if (p >= 75) gradeBuckets.B++;
  else if (p >= 60) gradeBuckets.C++;
  else if (p >= 40) gradeBuckets.D++;
  else gradeBuckets.F++;
});

new Chart(document.getElementById('pieChart'), {
  type: 'pie',
  data: {
    labels: Object.keys(gradeBuckets),
    datasets: [{
      data: Object.values(gradeBuckets),
      backgroundColor: [
        '#36a2eb',
        '#ff6384',
        '#ffce56',
        '#4bc0c0',
        '#9966ff'
      ]
    }]
  },
  options: {
    plugins: {
      title: {
        display: true,
        text: 'Grade Distribution',
        color: '#fff'
      },
      legend: {
        labels: {
          color: '#fff'
        }
      },
      tooltip: {
        backgroundColor: isDarkMode ? '#333' : '#fff',
        titleColor: isDarkMode ? '#fff' : '#000',
        bodyColor: isDarkMode ? '#fff' : '#000'
      }
    }
  }
});

</script>
{% endblock %}
