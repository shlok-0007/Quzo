{% extends "base.html" %}
{% block content %}

<style>
  :root {
    --mobile-padding: 15px;
  }
  
  body {
    background: linear-gradient(135deg, var(--darker-gray), var(--dark-gray));
    color: var(--text-primary);
    min-height: 100vh;
    padding-bottom: 2rem;
  }
  
  .quiz-card {
    border-radius: 10px;
    margin-bottom: 15px;
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
    background-color: var(--dark-card);
    border: 1px solid var(--gray);
    overflow: hidden;
  }
  .accordion-button {
    font-weight: bold;
    font-size: 1.1rem;
    background-color: var(--dark-gray);
    color: var(--text-primary);
    border: none;
    padding: 1rem 1.25rem;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }
  .accordion-button:not(.collapsed) {
    background-color: var(--primary-accent);
    color: white;
  }
  .accordion-button::after {
    filter: brightness(0) invert(1);
  }
  .accordion-body {
    background-color: var(--dark-card);
    color: var(--text-primary);
    border-radius: 0 0 10px 10px;
  }
  .access-code-actions button {
    margin-left: 5px;
  }
  #quizSearch {
    margin-bottom: 20px;
    max-width: 100%;
    background-color: var(--light-gray);
    color: var(--text-primary);
    border-color: var(--gray);
  }
  .accordion-item {
    transition: all 0.3s ease-in-out;
  }
  @media (max-width: 768px) {
    .container {
      padding-left: var(--mobile-padding);
      padding-right: var(--mobile-padding);
    }
    
    .accordion-button {
      font-size: 1rem;
      padding: 0.75rem 1rem;
    }
    
    .access-code-actions {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
      align-items: center;
    }
    
    .access-code-actions button {
      margin: 0.25rem 0;
      padding: 0.25rem 0.5rem;
      font-size: 0.85rem;
    }
    
    .btn-group-sm > .btn, .btn-sm {
      padding: 0.25rem 0.5rem;
      font-size: 0.85rem;
    }
    
    .accordion-body {
      padding: 1rem;
    }
    
    .mb-3.d-flex {
      flex-direction: column;
      gap: 0.5rem;
    }
    
    .mb-3.d-flex .btn {
      width: 100%;
      margin: 0.25rem 0;
    }
    
    #quizSearch {
      width: 100% !important;
      margin: 0 0 1rem 0;
    }
    
    .btn-lg {
      padding: 0.5rem 1rem;
      font-size: 1rem;
    }
    
    .h4 {
      font-size: 1.25rem;
    }
  }
</style>

<h2 class="mb-4 text-white text-center">Your Quizzes</h2>
<div class="d-flex justify-content-center">
  <input type="text" id="quizSearch" class="form-control w-75 w-sm-100" placeholder="Search quiz...">
</div>

{% if quizzes %}
<div class="accordion mt-3" id="quizAccordion">
  {% for quiz in quizzes %}
  <div class="accordion-item quiz-card" data-title="{{ quiz.title | lower }}">
    <h2 class="accordion-header" id="heading{{ quiz.id }}">
      <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapse{{ quiz.id }}" aria-expanded="false" aria-controls="collapse{{ quiz.id }}">
        {{ quiz.title }}
      </button>
    </h2>
    <div id="collapse{{ quiz.id }}" class="accordion-collapse collapse" aria-labelledby="heading{{ quiz.id }}" data-bs-parent="#quizAccordion">
      <div class="accordion-body">
        <p><strong>Created:</strong> {{ quiz.created_at.strftime('%Y-%m-%d %H:%M') }}</p>
        {% if quiz.access_code %}
        <div class="mb-2 access-code-actions">
          <strong>Access Code:</strong>
          <span id="access-code-{{ quiz.id }}">{{ quiz.access_code }}</span>
          <button class="btn btn-sm btn-outline-secondary copy-code-btn" data-quiz-id="{{ quiz.id }}">üìã Copy</button>
          <button class="btn btn-sm btn-outline-primary edit-code-btn" data-quiz-id="{{ quiz.id }}">‚úèÔ∏è Edit</button>
        </div>
        {% endif %}
        <div class="mb-3 d-flex flex-column flex-md-row gap-2">
          <a href="{{ url_for('view_quiz_results', quiz_id=quiz.id) }}" class="btn btn-outline-warning btn-sm">View Full Results</a>
          <a href="{{ url_for('edit_quiz', quiz_id=quiz.id) }}" class="btn btn-outline-info btn-sm">Edit</a>
          <form action="{{ url_for('delete_quiz', quiz_id=quiz.id) }}" method="POST" onsubmit="return confirm('Are you sure you want to delete this quiz?')">
            <button type="submit" class="btn btn-outline-danger btn-sm">Delete</button>
          </form>
        </div>
        <div class="mt-2">
          <canvas id="chart{{ quiz.id }}" height="120"></canvas>
        </div>
      </div>
    </div>
  </div>
  {% endfor %}
</div>
{% else %}
<div class="d-flex flex-column align-items-center justify-content-center" style="min-height: 50vh;">
  <div class="text-center">
    <h4 class="mb-4">You haven't created any quizzes yet</h4>
    <a href="{{ url_for('ai_quiz_generator') }}" class="btn btn-primary btn-lg">
      <i class="fas fa-plus-circle me-2"></i>Create Your First Quiz
    </a>
    <p class="mt-3 text-muted">Or <a href="{{ url_for('create_quiz') }}" class="text-primary">create a quiz manually</a></p>
  </div>
</div>
{% endif %}

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
function copyAccessCode(quizId) {
  const text = document.getElementById(`access-code-${quizId}`).innerText;
  navigator.clipboard.writeText(text).then(() => {
    alert("Access code copied!");
  });
}

function editAccessCode(quizId) {
  // Check if there's already an input field for this quiz
  const existingInput = document.getElementById(`access-code-input-${quizId}`);
  if (existingInput) {
    return; // Exit if input field already exists
  }

  const currentSpan = document.getElementById(`access-code-${quizId}`);
  const oldCode = currentSpan.innerText;
  
  // Create input field
  const input = document.createElement('input');
  input.type = 'text';
  input.value = oldCode;
  input.classList.add('form-control', 'd-inline', 'w-auto');
  input.style.marginRight = '10px';
  input.id = `access-code-input-${quizId}`;
  
  // Create save button
  const saveBtn = document.createElement('button');
  saveBtn.innerText = 'üíæ Save';
  saveBtn.className = 'btn btn-sm btn-success';
  saveBtn.onclick = function() {
    const newCode = input.value.trim();
    if (!newCode) {
      alert('Access code cannot be empty');
      return;
    }
    
    fetch(`/professor/quiz/${quizId}/update_access_code`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ access_code: newCode })
    })
    .then(res => {
      if (res.ok) {
        currentSpan.innerText = newCode;
        cleanupEditElements();
      } else {
        throw new Error('Failed to update');
      }
    })
    .catch(error => {
      console.error('Error:', error);
      alert('Failed to update access code. Please try again.');
    });
  };

  // Handle escape key to cancel editing
  input.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
      cleanupEditElements();
    } else if (e.key === 'Enter') {
      saveBtn.click();
    }
  });

  // Function to clean up the input and save button
  function cleanupEditElements() {
    currentSpan.style.display = 'inline';
    if (input.parentNode) input.remove();
    if (saveBtn.parentNode) saveBtn.remove();
  }

  // Hide the span and show the input field
  currentSpan.style.display = 'none';
  currentSpan.parentNode.insertBefore(input, currentSpan);
  currentSpan.parentNode.insertBefore(saveBtn, currentSpan);
  
  // Focus the input field
  input.focus();
}

document.addEventListener('DOMContentLoaded', function () {
  const analytics = {{ quiz_analytics | tojson }};
  analytics.forEach(item => {
    const canvas = document.getElementById('chart' + item.quiz_id);
    if (canvas) {
      const ctx = canvas.getContext('2d');
      new Chart(ctx, {
        type: 'bar',
        data: {
          labels: ['Attempts', 'Avg Score'],
          datasets: [{
            label: item.quiz_title,
            data: [item.attempts, item.avg_score],
            backgroundColor: ['#36a2eb', '#ff6384']
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { display: false },
            title: { 
              display: true, 
              text: 'Analytics for ' + item.quiz_title,
              color: '#fff'
            }
          },
          scales: {
            y: {
              beginAtZero: true,
              ticks: { 
                stepSize: 1,
                color: '#fff'
              },
              grid: {
                color: 'rgba(255, 255, 255, 0.1)'
              }
            },
            x: {
              ticks: {
                color: '#fff'
              },
              grid: {
                color: 'rgba(255, 255, 255, 0.1)'
              }
            }
          }
        }
      });
    }
  });
});

  document.querySelectorAll('.copy-code-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      const quizId = btn.dataset.quizId;
      copyAccessCode(quizId);
    });
  });

  document.querySelectorAll('.edit-code-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      const quizId = btn.dataset.quizId;
      editAccessCode(quizId);
    });
  });

  document.getElementById('quizSearch').addEventListener('input', function () {
  const searchValue = this.value.toLowerCase();
  document.querySelectorAll('.accordion-item').forEach(item => {
    const title = item.getAttribute('data-title');
    item.style.display = title.includes(searchValue) ? '' : 'none';
  });
});
</script>

{% endblock %}
